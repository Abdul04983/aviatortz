import React, { useState, useEffect } from 'react';
import axios from 'axios';

const API = 'http://localhost:5000/api';

function App() {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [token, setToken] = useState(localStorage.getItem('token') || '');
  const [balance, setBalance] = useState(0);
  const [betAmount, setBetAmount] = useState('');
  const [cashOutMultiplier, setCashOutMultiplier] = useState('');
  const [result, setResult] = useState(null);
  const [crashMultiplier, setCrashMultiplier] = useState(null);
  const [betsHistory, setBetsHistory] = useState([]);
  const [isRegister, setIsRegister] = useState(false);

  // Load balance and username on token change
  useEffect(() => {
    if (token) {
      axios.get(`${API}/bet/history`, { headers: { Authorization: `Bearer ${token}` } })
        .then(res => setBetsHistory(res.data))
        .catch(() => logout());
      // No direct balance API, so we update after bet or login
    }
  }, [token]);

  const register = async () => {
    if (!username || !password) return alert('Enter username and password');
    try {
      await axios.post(`${API}/auth/register`, { username, password });
      alert('Registered successfully! Please login.');
      setIsRegister(false);
    } catch (err) {
      alert(err.response?.data?.message || 'Error registering');
    }
  };

  const login = async () => {
    if (!username || !password) return alert('Enter username and password');
    try {
      const res = await axios.post(`${API}/auth/login`, { username, password });
      setToken(res.data.token);
      setBalance(res.data.balance);
      localStorage.setItem('token', res.data.token);
      setResult(null);
      setCrashMultiplier(null);
    } catch (err) {
      alert(err.response?.data?.message || 'Error logging in');
    }
  };

  const logout = () => {
    setToken('');
    localStorage.removeItem('token');
    setBalance(0);
    setBetsHistory([]);
    setResult(null);
    setCrashMultiplier(null);
  };

  const placeBet = async () => {
    if (!betAmount || !cashOutMultiplier) return alert('Enter bet amount and cash out multiplier');
    if (isNaN(betAmount) || isNaN(cashOutMultiplier)) return alert('Invalid numbers');
    if (parseFloat(betAmount) <= 0 || parseFloat(cashOutMultiplier) <= 1) return alert('Bet amount > 0 and multiplier > 1');
    try {
      const res = await axios.post(`${API}/bet/place`,
        { amount: parseFloat(betAmount), cashOutMultiplier: parseFloat(cashOutMultiplier) },
        { headers: { Authorization: `Bearer ${token}` } });
      setResult(res.data.result);
      setBalance(res.data.balance);
      setCrashMultiplier(res.data.crashMultiplier);
      // Refresh bet history
      const history = await axios.get(`${API}/bet/history`, { headers: { Authorization: `Bearer ${token}` } });
      setBetsHistory(history.data);
    } catch (err) {
      alert(err.response?.data?.message || 'Error placing bet');
    }
  };

  if (!token) {
    return (
      <div style={{ padding: 20 }}>
        <h2>{isRegister ? 'Register' : 'Login'}</h2>
        <input placeholder="Username" value={username} onChange={e => setUsername(e.target.value)} />
        <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} />
        {isRegister ? (
          <>
            <button onClick={register}>Register</button>
            <p>Already have account? <span onClick={() => setIsRegister(false)} style={{color:'blue',cursor:'pointer'}}>Login here</span></p>
          </>
        ) : (
          <>
            <button onClick={login}>Login</button>
            <p>Don't have account? <span onClick={() => setIsRegister(true)} style={{color:'blue',cursor:'pointer'}}>Register here</span></p>
          </>
        )}
      </div>
    );
  }

  return (
    <div style={{ padding: 20, maxWidth: 600, margin: 'auto' }}>
      <h2>Welcome, {username}</h2>
      <p>Balance: {balance.toFixed(2)}</p>
      <div>
        <input
          type="number"
          placeholder="Bet Amount"
          value={betAmount}
          onChange={e => setBetAmount(e.target.value)}
          style={{ marginRight: 10 }}
        />
        <input
          type="number"
          step="0.01"
          placeholder="Cash Out Multiplier (e.g. 2.0)"
          value={cashOutMultiplier}
          onChange={e => setCashOutMultiplier(e.target.value)}
          style={{ marginRight: 10 }}
        />
        <button onClick={placeBet}>Place Bet</button>
      </div>

      {result && (
        <div style={{ marginTop: 20 }}>
          <h3>Last Bet Result: {result.toUpperCase()}</h3>
          <p>Crash Multiplier was: {crashMultiplier}</p>
        </div>
      )}

      <h3>Bet History</h3>
      <table width="100%" border="1" cellPadding="5" style={{ borderCollapse: 'collapse' }}>
        <thead>
          <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Cash Out Multiplier</th>
            <th>Crash Multiplier</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody>
          {betsHistory.map(bet => (
            <tr key={bet._id}>
              <td>{new Date(bet.date).toLocaleString()}</td>
              <td>{bet.amount}</td>
              <td>{bet.cashOutMultiplier}</td>
              <td>{bet.crashMultiplier}</td>
              <td>{bet.result}</td>
            </tr>
          ))}
        </tbody>
      </table>

      <button style={{ marginTop: 20 }} onClick={logout}>Logout</button>
    </div>
  );
}

export default App;
